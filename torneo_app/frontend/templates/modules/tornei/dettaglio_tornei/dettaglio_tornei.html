{% extends "modules/base/base.html" %}
{% load static %}
{% block title %}Dettaglio {{ torneo.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.1/dist/jquery.bracket.min.css">
<link rel="stylesheet" href="{% static 'tornei/dettaglio_tornei/dettaglio_tornei.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .squadra-draggable {
    background-color: #2b2b2b;
    color: #fff;
    padding: 8px 12px;
    border: 1px solid #666;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: grab;
  }
  .squadra-draggable:hover {
    background-color: #444;
  }
</style>
{% endblock %}

{% block content %}
<div class="container text-light py-4">
  <!-- ðŸ† Intestazione torneo -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="text-warning">{{ torneo.nome }}</h1>
      <span class="badge bg-success">In corso</span>
      <span class="badge bg-secondary">ðŸ“… {{ torneo.data_inizio }} - {{ torneo.data_fine }}</span>
    </div>
  </div>

  <!-- Layout principale: colonne con squadre e bracket -->
  <div class="row">
    <!-- Colonna squadre disponibili -->
    <div class="col-md-3">
      <h5 class="text-warning">Squadre disponibili</h5>
      <div id="lista-squadre">
        <div class="squadra-draggable" draggable="true">ðŸ”¥ DragonFury</div>
        <div class="squadra-draggable" draggable="true">ðŸ’€ Memento</div>
        <div class="squadra-draggable" draggable="true">âš¡ Roma ASD</div>
        <div class="squadra-draggable" draggable="true">ðŸ¤¡ Clown</div>
      </div>
    </div>

    <!-- Colonna bracket -->
    <div class="col-md-9">
      <div class="card bg-dark border-light rounded shadow-sm">
        <div class="card-header border-bottom border-secondary">
          <ul class="nav nav-tabs card-header-tabs" id="tab-fasi">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fase-1">Fase 1</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fase-2">Fase 2</button>
            </li>
          </ul>
        </div>
        <div class="card-body tab-content mt-3">
          <!-- Fase 1 con Bracket -->
          <div class="tab-pane fade show active" id="fase-1">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="text-warning">Bracket Manuale</h5>
              <button class="btn btn-outline-warning btn-sm" id="btn-generabracket">
                <i class="bi bi-shuffle"></i> Genera Bracket Automatico
              </button>
            </div>
            <div class="bracket-wrapper">
              <div id="bracket-1"></div>
            </div>
          </div>

          <!-- Fase 2 placeholder -->
          <div class="tab-pane fade" id="fase-2">
            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-2"></i> Questa fase non Ã¨ ancora supportata.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.1/dist/jquery.bracket.min.js"></script>
<script>
  let currentBracketData = null;

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function generaBracketMock() {
    const squadre = Array.from(document.querySelectorAll('#lista-squadre .squadra-draggable')).map(el => el.textContent.trim());
    const shuffled = shuffleArray([...squadre]);
    const teams = [];
    for (let i = 0; i < shuffled.length; i += 2) {
      teams.push([shuffled[i] || '', shuffled[i + 1] || '']);
    }

    const numRounds = Math.ceil(Math.log2(teams.length));
    const results = Array.from({ length: numRounds }, (_, i) =>
      Array.from({ length: Math.ceil(teams.length / Math.pow(2, i + 1)) }, () => [null, null])
    );

    currentBracketData = {
      teams: teams,
      results: results
    };

    renderBracket(currentBracketData);
    setTimeout(enableManualDrop, 200);
  }

  function renderBracket(data) {
    $('#bracket-1').empty().bracket({
      init: data,
      save: function (matchData, roundIdx, matchIdx) {
        currentBracketData.results[roundIdx][matchIdx] = matchData.score;
        console.log("Punteggio aggiornato:", matchData);
      },
      disableToolbar: true,
      disableTeamEdit: true
    });
  }

  function enableManualDrop() {
    document.querySelectorAll('.team').forEach(slot => {
      slot.setAttribute("droppable", true);
      slot.addEventListener('dragover', e => e.preventDefault());
      slot.addEventListener('drop', e => {
        const name = e.dataTransfer.getData("text/plain");
        const allSlots = Array.from(document.querySelectorAll('.team'));
        const index = allSlots.indexOf(slot);
        const teamIndex = Math.floor(index / 2);
        const side = index % 2;

        if (!currentBracketData.teams[teamIndex]) {
          currentBracketData.teams[teamIndex] = ["", ""];
        }

        currentBracketData.teams[teamIndex][side] = name;
        currentBracketData.results[0][teamIndex] = [null, null];
        renderBracket(currentBracketData);
        setTimeout(enableManualDrop, 200);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    currentBracketData = {
      teams: [
        ["", ""],
        ["", ""]
      ],
      results: [
        [
          [null, null],
          [null, null]
        ],
        [
          [null, null]
        ]
      ]
    };

    renderBracket(currentBracketData);
    enableManualDrop();

    document.getElementById('btn-generabracket').addEventListener('click', () => {
      generaBracketMock();
    });

    document.querySelectorAll('.squadra-draggable').forEach(el => {
      el.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData("text/plain", e.target.textContent);
      });
    });
  });
</script>
{% endblock extra_js %}
